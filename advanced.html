<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FinalSay.ai — Advanced Reply</title>
<style>
  :root{--bg:#0f0f12;--panel:#17171c;--line:#2a2a36;--text:#eef;--muted:#a8a8b6;--accent:#ff5c5c;--accent2:#ff7a7a}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:1180px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .logo{display:block;width:220px;max-width:60vw}
  .nav{display:flex;gap:10px;flex-wrap:wrap}
  .nav a{background:#21212a;color:#fff;border:1px solid var(--line);padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:800}
  .layout{display:grid;grid-template-columns:320px 1fr;gap:16px}
  .sidebar{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .container{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{font-size:clamp(22px,4.5vw,30px);margin:10px 0}
  label{display:block;margin:12px 0 6px}
  textarea{width:100%;min-height:120px;background:#1e1e26;color:#eef;border:1px solid var(--line);border-radius:10px;padding:12px;font-size:16px;outline:none}
  .small{min-height:80px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#21212a;color:#eee;cursor:pointer;font-weight:800;font-size:12px}
  .chip.active{background:linear-gradient(90deg,var(--accent),var(--accent2));border-color:transparent}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-top:10px}
  .slider{background:#1b1b23;border:1px solid var(--line);border-radius:12px;padding:12px}
  .slider label{margin:0 0 6px 0;font-size:13px;color:#ddd;display:flex;justify-content:space-between}
  .slider input[type=range]{width:100%}
  .row{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:none;padding:12px 14px;border-radius:10px;font-weight:900;cursor:pointer;box-shadow:0 8px 24px rgba(255,92,92,.35)}
  .btn.secondary{background:#21212a;border:1px solid var(--line)}
  .hint{color:var(--muted);font-size:12px}
  .reply{background:#1b1b23;border:1px solid var(--line);margin:10px 0;padding:14px;border-radius:10px;cursor:pointer;line-height:1.5;white-space:pre-wrap}
  .reply:hover{background:#23232c}.reply.copied{outline:2px solid var(--accent)}
  .meter{margin-top:14px;display:flex;align-items:center;gap:10px}
  .bar{flex:1;height:10px;background:#22232b;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .count{font-size:12px;color:#d8d8e4;min-width:160px;text-align:right}

  .sidegroup{margin-bottom:12px}
  .sidegroup h3{margin:4px 0 6px;font-size:14px;color:#cfd6ff}
  .sidegroup input{width:100%;background:#1e1e26;color:#eef;border:1px solid var(--line);border-radius:10px;padding:10px}
  .persona-list{max-height:52vh;overflow:auto;display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .persona{display:flex;justify-content:space-between;gap:10px;align-items:center;background:#20202a;border:1px solid var(--line);border-radius:10px;padding:8px 10px}
  .persona .name{font-weight:800}
  .persona .sector{font-size:11px;color:#a8a8b6}
  .persona .use{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#2a2a35;color:#fff;cursor:pointer}
  .pill{padding:3px 8px;border-radius:999px;background:#2a2a35;border:1px solid var(--line);font-size:11px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <a href="/"><svg class="logo" viewBox="0 0 680 120" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#ff5c5c"/><stop offset="100%" stop-color="#ff7a7a"/></linearGradient></defs><text x="0" y="82" font-family="Inter, Arial, sans-serif" font-weight="900" font-size="72" fill="url(#g)">FinalSay.ai</text></svg></a>
    <nav class="nav">
      <a href="/">Modes</a>
      <a href="/personas.html">Personas</a>
      <a href="/build-voice.html">Build Your Voice</a>
      <a href="/favorites.html">Favorites</a>
      <a href="/history.html">History</a>
      <a href="/privacy.html">Privacy</a>
      <a href="/terms.html">Terms</a>
    </nav>
  </header>

  <div class="layout">
    <!-- Sidebar: Personas -->
    <aside class="sidebar">
      <div class="sidegroup">
        <h3>Persona Presets</h3>
        <input id="psearch" placeholder="Search personas…"/>
      </div>
      <div id="pcounts" class="hint"></div>
      <div id="plist" class="persona-list"></div>
      <div class="sidegroup" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="reloadPersonas" class="btn secondary">Reload Personas</button>
        <button id="savePreset" class="btn secondary">Save Current as Preset</button>
        <button id="setDefault" class="btn secondary">Set as Default</button>
      </div>
      <div class="hint" style="margin-top:6px">Tip: Add more presets by placing <code>/personas.json</code> at site root (120–150 “no‑limits” edition). This page will auto‑load it.</div>
    </aside>

    <!-- Main -->
    <main class="container">
      <h1>Advanced Reply</h1>
      <div class="hint">Paste the message you want to respond to, then (optionally) add context and your goal. Pick intents, load a persona, or tune sliders. You’ll get a tailored long reply.</div>

      <!-- NEW: Primary message box -->
      <label for="message">Message to reply to</label>
      <textarea id="message" class="small" placeholder="Paste the exact text you want to respond to."></textarea>

      <label for="scenario">Describe the scenario (context, who said what, constraints)</label>
      <textarea id="scenario" placeholder="Example: My manager publicly criticized my work in Slack for being 'slow.' I want to push back, ask for clearer expectations, and protect the relationship."></textarea>

      <label for="intentText">Your intent (desired outcome)</label>
      <textarea id="intentText" class="small" placeholder="Example: Defend my work calmly, ask for expectations and a 1:1, and set a boundary about public call-outs."></textarea>

      <div class="hint" style="margin-top:6px;">Quick intents (optional): tap to include</div>
      <div class="chips" id="intents">
        <button class="chip" data-intent="Defuse tension">Defuse tension</button>
        <button class="chip" data-intent="Persuade">Persuade</button>
        <button class="chip" data-intent="Set boundary">Set boundary</button>
        <button class="chip" data-intent="Request clarity">Request clarity</button>
        <button class="chip" data-intent="Educate politely">Educate politely</button>
        <button class="chip" data-intent="Disagree respectfully">Disagree respectfully</button>
        <button class="chip" data-intent="Win the argument">Win the argument</button>
        <button class="chip" data-intent="Be funny">Be funny</button>
        <button class="chip" data-intent="Be professional">Be professional</button>
        <button class="chip" data-intent="Be compassionate">Be compassionate</button>
      </div>

      <div class="grid" id="eq">
        <div class="slider"><label>Political Lean <span id="v_politics">50</span></label><input id="politics" type="range" min="0" max="100" value="50"></div>
        <div class="slider"><label>Science ↔ Spiritual <span id="v_scispir">50</span></label><input id="scispir" type="range" min="0" max="100" value="50"></div>
        <div class="slider"><label>Heat (Zen ↔ Hot) <span id="v_heat">40</span></label><input id="heat" type="range" min="0" max="100" value="40"></div>
        <div class="slider"><label>Formality <span id="v_formality">55</span></label><input id="formality" type="range" min="0" max="100" value="55"></div>
        <div class="slider"><label>Empathy <span id="v_empathy">70</span></label><input id="empathy" type="range" min="0" max="100" value="70"></div>
        <div class="slider"><label>Directness <span id="v_direct">65</span></label><input id="direct" type="range" min="0" max="100" value="65"></div>
        <div class="slider"><label>Humor (Dry ↔ Absurd) <span id="v_humor">45</span></label><input id="humor" type="range" min="0" max="100" value="45"></div>
        <div class="slider"><label>Sarcasm/Roast <span id="v_roast">35</span></label><input id="roast" type="range" min="0" max="100" value="35"></div>
        <div class="slider"><label>Optimism (Cynical ↔ Idealist) <span id="v_optimism">60</span></label><input id="optimism" type="range" min="0" max="100" value="60"></div>
        <div class="slider"><label>Length (Short ↔ Long) <span id="v_length">75</span></label><input id="length" type="range" min="0" max="100" value="75"></div>
      </div>

      <div class="row">
        <button id="generate" class="btn">Generate Advanced Reply</button>
        <button id="reset" class="btn secondary">Reset</button>
      </div>

      <div id="status" class="hint"></div>
      <div id="output" class="reply" style="display:none"></div>

      <div class="meter" aria-live="polite">
        <div class="bar"><div id="fill" class="fill"></div></div>
        <div id="counter" class="count">0 / 10 free today</div>
      </div>
    </main>
  </div>
</div>

<script>
  // ===== Config =====
  const PREMIUM_ENABLED = false; // flip to true when you want paywall active
  const DAILY_LIMIT=10;
  const HISTORY_KEY='fs_history';
  const PROFILE_KEY='fs_custom_voices';
  const DEFAULT_ID_KEY='fs_default_voice_id';
  const PREMIUM_FLAG='fs_is_premium';

  // ===== Intent chips =====
  const intentSet = new Set();
  document.getElementById('intents').addEventListener('click', (e)=>{
    if(!e.target.classList.contains('chip')) return;
    const val = e.target.dataset.intent;
    if(intentSet.has(val)){ intentSet.delete(val); e.target.classList.remove('active'); }
    else { intentSet.add(val); e.target.classList.add('active'); }
  });

  // ===== Sliders + labels =====
  const slidersList=['politics','scispir','heat','formality','empathy','direct','humor','roast','optimism','length'];
  slidersList.forEach(id=>{
    const el=document.getElementById(id);
    const v=document.getElementById('v_'+(id==='scispir'?'scispir':id));
    const update=()=>v.textContent=el.value;
    el.addEventListener('input',update); update();
  });

  // ===== Usage meter =====
  const todayKey=()=>{const d=new Date();return `fs_uses_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
  const getCount=()=>Number(localStorage.getItem(todayKey())||0);
  const bump=()=>{const k=todayKey();localStorage.setItem(k,String(getCount()+1));refreshMeter();}
  const refreshMeter=()=>{const used=getCount();const pct=Math.min(100,Math.round((used/DAILY_LIMIT)*100));document.getElementById('fill').style.width=pct+'%';document.getElementById('counter').textContent=`${used} / ${DAILY_LIMIT} free today`;};
  refreshMeter();

  // ===== History save =====
  function saveHistoryAdvanced(entry){
    const list = JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]');
    list.unshift(entry);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(0,200)));
  }

  // ===== Personas loader (auto-load /personas.json if available) =====
  const FALLBACK_PERSONAS = [
    {id:'buddha',name:'Buddha',sector:'Spiritual & Mystical',defaults:{politics:50,scispir:65,heat:10,formality:60,empathy:95,direct:55,humor:5,roast:0,optimism:80,length:70},premium:false},
    {id:'roastmaster',name:'Roastmaster',sector:'Humor & Satire',defaults:{politics:50,scispir:45,heat:65,formality:40,empathy:35,direct:85,humor:95,roast:85,optimism:55,length:45},premium:false},
    {id:'hostage',name:'Hostage Negotiator',sector:'Negotiation & Influence',defaults:{politics:50,scispir:45,heat:25,formality:65,empathy:85,direct:55,humor:10,roast:0,optimism:45,length:75},premium:false},
    {id:'yoda',name:'Yoda (homage)',sector:'Pop Culture & Fictional',defaults:{politics:50,scispir:70,heat:10,formality:65,empathy:85,direct:55,humor:20,roast:10,optimism:70,length:55},premium:false},
    {id:'greedy',name:'Greedy Mogul',sector:'Vices & Extremes',defaults:{politics:50,scispir:40,heat:45,formality:65,empathy:20,direct:85,humor:25,roast:20,optimism:55,length:50},premium:false}
  ];

  async function fetchPersonas(){
    try{
      const res = await fetch('/personas.json',{cache:'no-store'});
      if(!res.ok) throw new Error('not found');
      const data = await res.json();
      return Array.isArray(data.personas)?data.personas:FALLBACK_PERSONAS;
    }catch{ return FALLBACK_PERSONAS; }
  }

  function renderPersonas(list){
    const plist=document.getElementById('plist');
    const pcounts=document.getElementById('pcounts');
    plist.innerHTML='';
    pcounts.textContent = `${list.length} persona${list.length!==1?'s':''} loaded`;
    const q = (document.getElementById('psearch').value||'').toLowerCase().trim();
    list.filter(p=>{
      if(!q) return true;
      return (p.name+' '+(p.sector||'')).toLowerCase().includes(q);
    }).forEach(p=>{
      const el=document.createElement('div');
      const gatingOn = PREMIUM_ENABLED;
      const showUnlock = (gatingOn && p.premium && localStorage.getItem(PREMIUM_FLAG)!=='1');
      el.className='persona';
      el.innerHTML=`<div><div class="name">${p.name} ${p.premium?'<span class="pill">Pro</span>':''}</div><div class="sector">${p.sector||''}</div></div><button class="use">${showUnlock?'Unlock':'Load'}</button>`;
      el.querySelector('.use').onclick=()=>applyPersona(p, gatingOn);
      plist.appendChild(el);
    });
  }

  // Boot personas
  let _personas=[];
  (async function initPersonas(){
    _personas = await fetchPersonas();
    renderPersonas(_personas);
  })();
  document.getElementById('psearch').oninput=()=>renderPersonas(_personas);
  document.getElementById('reloadPersonas').onclick=async()=>{ _personas=await fetchPersonas(); renderPersonas(_personas); };

  // ===== Apply persona with premium guard (respects toggle) =====
  function applyPersona(p, gatingOn){
    const upgraded = localStorage.getItem(PREMIUM_FLAG)==='1';
    if(gatingOn && p.premium && !upgraded){
      localStorage.setItem('fs_pending_persona', p.id);
      localStorage.setItem('fs_apply_persona', JSON.stringify(p));
      window.location.href='/premium.html';
      return;
    }
    if(p.defaults){
      for(const k in p.defaults){
        const el=document.getElementById(k);
        if(el){ el.value=p.defaults[k]; const v=document.getElementById('v_'+(k==='scispir'?'scispir':k)); if(v) v.textContent=p.defaults[k]; }
      }
    }
  }

  // ===== Reopen routes + default loader =====
  (function bootLoaders(){
    const url=new URL(location.href);

    // From Personas page: applyPersona
    if(url.searchParams.get('applyPersona')==='1'){
      const raw=localStorage.getItem('fs_apply_persona');
      if(raw){
        try{
          const p=JSON.parse(raw);
          const upgraded = localStorage.getItem(PREMIUM_FLAG)==='1';
          if(PREMIUM_ENABLED && p.premium && !upgraded){
            localStorage.setItem('fs_pending_persona', p.id);
            window.location.href='/premium.html';
            return;
          }
          if(p.defaults){ for(const k in p.defaults){ const el=document.getElementById(k); if(el){ el.value=p.defaults[k]; const v=document.getElementById('v_'+(k==='scispir'?'scispir':k)); if(v) v.textContent=p.defaults[k]; } } }
        }catch{}
        localStorage.removeItem('fs_apply_persona');
      }
    }
  })();

  // ===== Generate =====
  const btn=document.getElementById('generate'),out=document.getElementById('output'),statusEl=document.getElementById('status');
  btn.addEventListener('click', async ()=>{
    const message=document.getElementById('message').value.trim();
    const scenario=document.getElementById('scenario').value.trim();
    const intentText=document.getElementById('intentText').value.trim();
    if(!message && !scenario){
      return alert('Please paste the message to reply to, or describe the scenario (ideally both).');
    }
    const sliders=Object.fromEntries(['politics','scispir','heat','formality','empathy','direct','humor','roast','optimism','length'].map(k=>[k,+document.getElementById(k).value]));
    const payload={ mode:'advanced', message, scenario, intentText, intents:Array.from(intentSet), sliders };
    btn.disabled=true; btn.textContent='Weaving…'; statusEl.textContent='Composing a long, tailored reply…'; out.style.display='none'; out.textContent='';
    try{
      const res=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const data=await res.json(); if(!res.ok) throw new Error(data.error||'Error');
      const reply=Array.isArray(data.replies)?data.replies.join('\n\n'):String(data.replies);
      out.textContent=reply; out.style.display='block';
      out.onclick=async()=>{await navigator.clipboard.writeText(out.textContent); out.classList.add('copied'); setTimeout(()=>out.classList.remove('copied'),700);};
      saveHistoryAdvanced({ ts: Date.now(), mode:'advanced', message, scenario, intentText, intents:Array.from(intentSet), sliders, output: reply });
      bump(); statusEl.textContent='';
    }catch(e){out.style.display='block'; out.textContent='Error: '+e.message; statusEl.textContent='Try again in a moment.';}
    finally{btn.disabled=false; btn.textContent='Generate Advanced Reply';}
  });

  // ===== Reset =====
  document.getElementById('reset').addEventListener('click',()=>{
    document.getElementById('message').value='';
    document.getElementById('scenario').value='';
    document.getElementById('intentText').value='';
    document.querySelectorAll('.chip.active').forEach(c=>c.classList.remove('active'));
    intentSet.clear();
    const defaults={politics:50,scispir:50,heat:40,formality:55,empathy:70,direct:65,humor:45,roast:35,optimism:60,length:75};
    for(const k in defaults){document.getElementById(k).value=defaults[k]; document.getElementById('v_'+(k==='scispir'?'scispir':k)).textContent=defaults[k];}
  });
</script>
</body>
</html>
