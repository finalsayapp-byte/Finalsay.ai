<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FinalSay.ai — Advanced Reply</title>
<style>
  :root{--bg:#0f0f12;--panel:#17171c;--line:#2a2a36;--text:#eef;--muted:#a8a8b6;--accent:#ff5c5c;--accent2:#ff7a7a}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:1180px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .logo{display:block;width:220px;max-width:60vw}
  .nav{display:flex;gap:10px;flex-wrap:wrap}
  .nav a{background:#21212a;color:#fff;border:1px solid var(--line);padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:800}
  .layout{display:grid;grid-template-columns:320px 1fr;gap:16px}
  .sidebar{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .container{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{font-size:clamp(22px,4.5vw,30px);margin:10px 0}
  label{display:block;margin:12px 0 6px}
  textarea{width:100%;min-height:120px;background:#1e1e26;color:#eef;border:1px solid var(--line);border-radius:10px;padding:12px;font-size:16px;outline:none}
  .small{min-height:80px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#21212a;color:#eee;cursor:pointer;font-weight:800;font-size:12px}
  .chip.active{background:linear-gradient(90deg,var(--accent),var(--accent2));border-color:transparent}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin-top:10px}
  .slider{background:#1b1b23;border:1px solid var(--line);border-radius:12px;padding:12px}
  .slider label{margin:0 0 6px 0;font-size:13px;color:#ddd;display:flex;justify-content:space-between}
  .slider input[type=range]{width:100%}
  .row{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:none;padding:12px 14px;border-radius:10px;font-weight:900;cursor:pointer;box-shadow:0 8px 24px rgba(255,92,92,.35)}
  .btn.secondary{background:#21212a;border:1px solid var(--line)}
  .hint{color:var(--muted);font-size:12px}
  .reply{background:#1b1b23;border:1px solid var(--line);margin:10px 0;padding:14px;border-radius:10px;cursor:pointer;line-height:1.5;white-space:pre-wrap}
  .reply:hover{background:#23232c}.reply.copied{outline:2px solid var(--accent)}
  .meter{margin-top:14px;display:flex;align-items:center;gap:10px}
  .bar{flex:1;height:10px;background:#22232b;border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .count{font-size:12px;color:#d8d8e4;min-width:160px;text-align:right}

  .sidegroup{margin-bottom:12px}
  .sidegroup h3{margin:4px 0 6px;font-size:14px;color:#cfd6ff}
  .sidegroup input{width:100%;background:#1e1e26;color:#eef;border:1px solid var(--line);border-radius:10px;padding:10px}
  .persona-list{max-height:52vh;overflow:auto;display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .persona{display:flex;justify-content:space-between;gap:10px;align-items:center;background:#20202a;border:1px solid var(--line);border-radius:10px;padding:8px 10px}
  .persona .name{font-weight:800}
  .persona .sector{font-size:11px;color:#a8a8b6}
  .pill{padding:3px 8px;border-radius:999px;background:#2a2a35;border:1px solid var(--line);font-size:11px}

  .rowline{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0 2px}
  .switch{display:inline-flex;align-items:center;gap:8px;background:#1b1b23;border:1px solid var(--line);padding:8px 10px;border-radius:10px}
  .switch input{transform:scale(1.2)}
  .seg{display:inline-flex;border:1px solid var(--line);border-radius:10px;overflow:hidden}
  .seg button{background:#1b1b23;color:#fff;border:none;padding:8px 10px;cursor:pointer}
  .seg button.active{background:#2a2a35}
  .sources{font-size:13px;color:#cfd6ff}
  .sources a{color:#ffb3b3}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <a href="/"><svg class="logo" viewBox="0 0 680 120" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#ff5c5c"/><stop offset="100%" stop-color="#ff7a7a"/></linearGradient></defs><text x="0" y="82" font-family="Inter, Arial, sans-serif" font-weight="900" font-size="72" fill="url(#g)">FinalSay.ai</text></svg></a>
    <nav class="nav">
      <a href="/">Modes</a>
      <a href="/personas.html">Personas</a>
      <a href="/build-voice.html">Build Your Voice</a>
      <a href="/favorites.html">Favorites</a>
      <a href="/history.html">History</a>
      <a href="/privacy.html">Privacy</a>
      <a href="/terms.html">Terms</a>
    </nav>
  </header>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidegroup">
        <h3>Persona Presets</h3>
        <input id="psearch" placeholder="Search personas…"/>
      </div>
      <div id="pcounts" class="hint"></div>
      <div id="plist" class="persona-list"></div>
      <div class="sidegroup" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="reloadPersonas" class="btn secondary">Reload Personas</button>
        <button id="savePreset" class="btn secondary">Save Current as Preset</button>
        <button id="setDefault" class="btn secondary">Set as Default</button>
      </div>
      <div class="hint" style="margin-top:6px">Tip: Add more presets by placing <code>/personas.json</code> at site root.</div>
    </aside>

    <!-- Main -->
    <main class="container">
      <h1>Advanced Reply</h1>
      <div class="hint">Choose a path: **Reply** (copy‑ready) or **Advice + Sources** (strategy notes + links).</div>

      <div class="rowline">
        <label class="switch"><input id="directOnly" type="checkbox" checked/> Direct, copy‑ready reply (no advice)</label>
        <div class="switch">Format:
          <span class="seg" id="formatSeg">
            <button data-fmt="short" class="active">Short</button>
            <button data-fmt="normal">Normal</button>
            <button data-fmt="long">Long</button>
          </span>
        </div>
        <label class="switch"><input id="wantSources" type="checkbox"/> Include sources (for advice mode)</label>
      </div>

      <label for="message">Message to reply to</label>
      <textarea id="message" class="small" placeholder="Paste the exact text you want to respond to." autofocus></textarea>

      <label for="scenario">Describe the scenario (context, who said what, constraints)</label>
      <textarea id="scenario" placeholder="Example: My manager publicly criticized my work in Slack for being 'slow.' I want to push back, ask for clearer expectations, and protect the relationship."></textarea>

      <label for="intentText">Your intent (desired outcome)</label>
      <textarea id="intentText" class="small" placeholder="Example: Defend my work calmly, ask for expectations and a 1:1, and set a boundary about public call-outs."></textarea>

      <div class="hint" style="margin-top:6px;">Quick intents (optional): tap to include</div>
      <div class="chips" id="intents">
        <button class="chip" data-intent="Defuse tension">Defuse tension</button>
        <button class="chip" data-intent="Persuade">Persuade</button>
        <button class="chip" data-intent="Set boundary">Set boundary</button>
        <button class="chip" data-intent="Request clarity">Request clarity</button>
        <button class="chip" data-intent="Educate politely">Educate politely</button>
        <button class="chip" data-intent="Disagree respectfully">Disagree respectfully</button>
        <button class="chip" data-intent="Win the argument">Win the argument</button>
        <button class="chip" data-intent="Be funny">Be funny</button>
        <button class="chip" data-intent="Be professional">Be professional</button>
        <button class="chip" data-intent="Be compassionate">Be compassionate</button>
      </div>

      <div class="grid" id="eq">
        <div class="slider"><label>Political Lean <span id="v_politics">50</span></label><input id="politics" type="range" min="0" max="100" value="50"></div>
        <div class="slider"><label>Science ↔ Spiritual <span id="v_scispir">50</span></label><input id="scispir" type="range" min="0" max="100" value="50"></div>
        <div class="slider"><label>Heat (Zen ↔ Hot) <span id="v_heat">40</span></label><input id="heat" type="range" min="0" max="100" value="40"></div>
        <div class="slider"><label>Formality <span id="v_formality">55</span></label><input id="formality" type="range" min="0" max="100" value="55"></div>
        <div class="slider"><label>Empathy <span id="v_empathy">70</span></label><input id="empathy" type="range" min="0" max="100" value="70"></div>
        <div class="slider"><label>Directness <span id="v_direct">65</span></label><input id="direct" type="range" min="0" max="100" value="65"></div>
        <div class="slider"><label>Humor (Dry ↔ Absurd) <span id="v_humor">45</span></label><input id="humor" type="range" min="0" max="100" value="45"></div>
        <div class="slider"><label>Sarcasm/Roast <span id="v_roast">35</span></label><input id="roast" type="range" min="0" max="100" value="35"></div>
        <div class="slider"><label>Optimism (Cynical ↔ Idealist) <span id="v_optimism">60</span></label><input id="optimism" type="range" min="0" max="100" value="60"></div>
        <div class="slider"><label>Length (Short ↔ Long) <span id="v_length">75</span></label><input id="length" type="range" min="0" max="100" value="75"></div>
      </div>

      <div class="row">
        <button id="generate" class="btn">Generate Advanced Reply</button>
        <button id="advice" class="btn secondary">Get Advice + Sources</button>
        <button id="reset" class="btn secondary">Reset</button>
      </div>

      <div id="status" class="hint"></div>
      <div id="output" class="reply" style="display:none"></div>
      <div id="sources" class="sources" style="display:none"></div>

      <div class="meter" aria-live="polite">
        <div class="bar"><div id="fill" class="fill"></div></div>
        <div id="counter" class="count">0 / 10 free today</div>
      </div>
    </main>
  </div>
</div>

<script>
  const PREMIUM_ENABLED=false, DAILY_LIMIT=10, HISTORY_KEY='fs_history', PREMIUM_FLAG='fs_is_premium';

  // Intent chips
  const intentSet=new Set();
  document.getElementById('intents').addEventListener('click',(e)=>{
    if(!e.target.classList.contains('chip')) return;
    const v=e.target.dataset.intent;
    if(intentSet.has(v)){intentSet.delete(v);e.target.classList.remove('active');}
    else{intentSet.add(v);e.target.classList.add('active');}
  });

  // Format seg
  let replyFormat='short';
  document.getElementById('formatSeg').addEventListener('click',(e)=>{
    if(e.target.tagName!=='BUTTON') return;
    [...e.currentTarget.children].forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active'); replyFormat=e.target.dataset.fmt;
  });

  // Sliders labels
  ['politics','scispir','heat','formality','empathy','direct','humor','roast','optimism','length'].forEach(id=>{
    const el=document.getElementById(id), v=document.getElementById('v_'+(id==='scispir'?'scispir':id));
    const up=()=>v.textContent=el.value; el.addEventListener('input',up); up();
  });

  // Meter
  const today=()=>{const d=new Date();return`fs_uses_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
  const used=()=>Number(localStorage.getItem(today())||0);
  const bump=()=>{const k=today();localStorage.setItem(k,String(used()+1));meter();}
  const meter=()=>{const u=used();document.getElementById('fill').style.width=Math.min(100,Math.round((u/DAILY_LIMIT)*100))+'%';document.getElementById('counter').textContent=`${u} / ${DAILY_LIMIT} free today`;}
  meter();

  // Personas (same as before, trimmed for brevity)
  const FALLBACK_PERSONAS=[{id:'buddha',name:'Buddha',sector:'Spiritual & Mystical',defaults:{politics:50,scispir:65,heat:10,formality:60,empathy:95,direct:55,humor:5,roast:0,optimism:80,length:70},premium:false},{id:'roastmaster',name:'Roastmaster',sector:'Humor & Satire',defaults:{politics:50,scispir:45,heat:65,formality:40,empathy:35,direct:85,humor:95,roast:85,optimism:55,length:45},premium:false},{id:'hostage',name:'Hostage Negotiator',sector:'Negotiation & Influence',defaults:{politics:50,scispir:45,heat:25,formality:65,empathy:85,direct:55,humor:10,roast:0,optimism:45,length:75},premium:false},{id:'yoda',name:'Yoda (homage)',sector:'Pop Culture & Fictional',defaults:{politics:50,scispir:70,heat:10,formality:65,empathy:85,direct:55,humor:20,roast:10,optimism:70,length:55},premium:false},{id:'greedy',name:'Greedy Mogul',sector:'Vices & Extremes',defaults:{politics:50,scispir:40,heat:45,formality:65,empathy:20,direct:85,humor:25,roast:20,optimism:55,length:50},premium:false}];
  async function fetchPersonas(){try{const r=await fetch('/personas.json',{cache:'no-store'});if(!r.ok)throw 0;const d=await r.json();return Array.isArray(d.personas)?d.personas:FALLBACK_PERSONAS;}catch{return FALLBACK_PERSONAS}}
  function renderPersonas(list){const plist=document.getElementById('plist'),pcounts=document.getElementById('pcounts');plist.innerHTML='';pcounts.textContent=`${list.length} personas loaded`;const q=(document.getElementById('psearch').value||'').toLowerCase().trim();list.filter(p=>!q||(p.name+' '+(p.sector||'')).toLowerCase().includes(q)).forEach(p=>{const el=document.createElement('div');const showUnlock=(PREMIUM_ENABLED&&p.premium&&localStorage.getItem(PREMIUM_FLAG)!=='1');el.className='persona';el.innerHTML=`<div><div class="name">${p.name} ${p.premium?'<span class="pill">Pro</span>':''}</div><div class="sector">${p.sector||''}</div></div><button class="use">${showUnlock?'Unlock':'Load'}</button>`;el.querySelector('.use').onclick=()=>applyPersona(p,PREMIUM_ENABLED);plist.appendChild(el);});}
  let _personas=[];(async()=>{_personas=await fetchPersonas();renderPersonas(_personas)})();document.getElementById('psearch').oninput=()=>renderPersonas(_personas);document.getElementById('reloadPersonas').onclick=async()=>{_personas=await fetchPersonas();renderPersonas(_personas);};
  function applyPersona(p,gatingOn){const upgraded=localStorage.getItem(PREMIUM_FLAG)==='1';if(gatingOn&&p.premium&&!upgraded){localStorage.setItem('fs_pending_persona',p.id);localStorage.setItem('fs_apply_persona',JSON.stringify(p));location.href='/premium.html';return;}if(p.defaults){for(const k in p.defaults){const el=document.getElementById(k);if(el){el.value=p.defaults[k];document.getElementById('v_'+(k==='scispir'?'scispir':k)).textContent=p.defaults[k];}}}}

  // Generate paths
  async function callApi({advice=false}){
    const message=document.getElementById('message').value.trim();
    const scenario=document.getElementById('scenario').value.trim();
    const intentText=document.getElementById('intentText').value.trim();
    if(!message && !scenario) return alert('Please paste the message to reply to, or describe the scenario (ideally both).');
    const sliders=Object.fromEntries(['politics','scispir','heat','formality','empathy','direct','humor','roast','optimism','length'].map(k=>[k,+document.getElementById(k).value]));
    const directOnly = !advice && document.getElementById('directOnly').checked;
    const wantSources = advice && document.getElementById('wantSources').checked;
    const payload={ mode:'advanced', message, scenario, intentText, intents:Array.from(intentSet), sliders, directOnly, replyFormat, adviceMode: advice, wantSources };
    const btn = advice ? document.getElementById('advice') : document.getElementById('generate');
    const out=document.getElementById('output'), src=document.getElementById('sources'), status=document.getElementById('status');
    btn.disabled=true; btn.textContent= advice ? 'Gathering advice…' : 'Weaving…';
    out.style.display='none'; src.style.display='none'; status.textContent= advice ? 'Generating strategy notes and sources…' : 'Composing a copy‑ready reply…';
    try{
      const res=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const data=await res.json(); if(!res.ok) throw new Error(data.error||'Error');
      const reply=Array.isArray(data.replies)?data.replies.join('\n\n'):String(data.replies||'');
      out.textContent=reply; out.style.display='block';
      out.onclick=async()=>{await navigator.clipboard.writeText(out.textContent); out.classList.add('copied'); setTimeout(()=>out.classList.remove('copied'),700);};
      if(advice && Array.isArray(data.sources)){
        src.innerHTML = data.sources.map(s=>`• <a href="${s.url}" target="_blank" rel="noopener">${s.title||s.url}</a> <span class="hint">(${s.domain||''})</span>`).join('<br/>');
        if(data.sources.length){ src.style.display='block'; }
      }
      const entry={ ts:Date.now(), mode: advice?'advanced_advice':'advanced', message, scenario, intentText, intents:Array.from(intentSet), sliders, directOnly, replyFormat, output: reply, sources: data.sources||[] };
      const list = JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]'); list.unshift(entry); localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(0,200)));
      bump(); status.textContent='';
    }catch(e){ out.style.display='block'; out.textContent='Error: '+e.message; status.textContent='Try again.'; }
    finally{ btn.disabled=false; btn.textContent= advice ? 'Get Advice + Sources' : 'Generate Advanced Reply'; }
  }

  document.getElementById('generate').onclick=()=>callApi({advice:false});
  document.getElementById('advice').onclick=()=>callApi({advice:true});

  // Reset
  document.getElementById('reset').addEventListener('click',()=>{
    document.getElementById('message').value='';
    document.getElementById('scenario').value='';
    document.getElementById('intentText').value='';
    document.querySelectorAll('.chip.active').forEach(c=>c.classList.remove('active')); intentSet.clear();
    const d={politics:50,scispir:50,heat:40,formality:55,empathy:70,direct:65,humor:45,roast:35,optimism:60,length:75};
    for(const k in d){document.getElementById(k).value=d[k]; document.getElementById('v_'+(k==='scispir'?'scispir':k)).textContent=d[k];}
    document.getElementById('output').style.display='none'; document.getElementById('sources').style.display='none';
  });

  // Autofocus
  document.getElementById('message').focus();
</script>
</body>
</html>
