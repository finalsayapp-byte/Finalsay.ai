<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FinalSay.ai ‚Äî Get the Last Word</title>
<style>
  :root{
    --bg:#0f0f12; --panel:#17171c; --line:#2a2a36; --text:#eef; --muted:#a8a8b6;
    --accent:#ff5c5c; --accent2:#ff7a7a; --hint:#20202a;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter, Arial, Helvetica, sans-serif; background:var(--bg); color:var(--text)}
  .wrap{max-width:980px; margin:0 auto; padding:20px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px}
  .logo{display:block; width:220px; max-width:60vw}
  .nav{display:flex; gap:10px; flex-wrap:wrap}
  .nav a{background:#21212a; color:#fff; border:1px solid var(--line); padding:10px 12px; border-radius:10px; text-decoration:none; font-weight:800}
  .nav a:hover{border-color:#3a3a46}
  h1{font-size:clamp(22px,4.5vw,30px); margin:10px 0 8px}
  .container{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:18px}
  .callout{
    display:flex; gap:10px; align-items:flex-start; margin:6px 0 14px;
    background:var(--hint); border:1px solid var(--line); border-radius:12px; padding:12px;
  }
  .callout b{color:#fff}
  .callout .icon{font-size:18px; line-height:1.1}
  label{display:block; margin:12px 0 6px}
  textarea{width:100%; min-height:150px; background:#1e1e26; color:#eef; border:1px solid var(--line); border-radius:10px; padding:12px; font-size:16px; outline:none}
  .tones{display:flex; flex-wrap:wrap; gap:8px; margin:10px 0}
  .tone{padding:8px 12px; border-radius:999px; border:1px solid var(--line); background:#21212a; color:#eee; cursor:pointer; font-weight:800; font-size:13px}
  .tone.active{background:linear-gradient(90deg,var(--accent),var(--accent2)); border-color:transparent}
  .actions{display:flex; gap:10px; margin:14px 0; flex-wrap:wrap}
  .btn{flex:1; background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#fff; border:none; padding:12px; border-radius:10px; font-weight:900; cursor:pointer; box-shadow:0 8px 24px rgba(255,92,92,.35)}
  .btn.secondary{flex:0 0 auto; background:#21212a; border:1px solid var(--line)}
  .btn:disabled{opacity:.6; cursor:not-allowed}
  .hint{color:var(--muted); font-size:12px}
  .reply{background:#1b1b23; border:1px solid var(--line); margin:10px 0; padding:12px; border-radius:10px; cursor:pointer}
  .reply:hover{background:#23232c}
  .reply.copied{outline:2px solid var(--accent)}
  .examples{margin-top:18px; border-top:1px dashed var(--line); padding-top:12px}
  .exline{margin:8px 0; font-size:14px}
  .exlabel{display:inline-block; min-width:170px; color:#ffa8a8}
  .meter{margin-top:14px; display:flex; align-items:center; gap:10px}
  .bar{flex:1; height:10px; background:#22232b; border:1px solid var(--line); border-radius:999px; overflow:hidden}
  .fill{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .count{font-size:12px; color:#d8d8e4; min-width:160px; text-align:right}
  /* OCR uploader */
  .uploader{margin-top:12px; padding:14px; border:1px dashed var(--line); border-radius:12px; background:#1b1b23}
  .uploader.drag{border-color:#ff9a7a; background:#20202a}
  .uploader .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .uploader input[type=file]{display:none}
  .uploader .pick, .uploader .camera{
    background:#21212a; border:1px solid var(--line); color:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:800
  }
  .ocr-status{margin-top:8px; font-size:12px; color:#d8d8e4}
  .ocr-progress{height:8px; background:#22232b; border:1px solid var(--line); border-radius:999px; overflow:hidden; margin-top:6px}
  .ocr-fill{height:100%; width:0%; background:linear-gradient(90deg,#ff9a7a,#ff5c5c)}
  footer{margin:26px 0 20px; text-align:center; color:#a8a8b6; font-size:14px}
  footer a{color:#ff7a7a; text-decoration:none; margin:0 6px}
  footer a:hover{text-decoration:underline}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <!-- Wordmark -->
      <svg class="logo" viewBox="0 0 680 120" xmlns="http://www.w3.org/2000/svg" aria-label="FinalSay.ai">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#ff5c5c"/>
            <stop offset="100%" stop-color="#ff9a7a"/>
          </linearGradient>
        </defs>
        <text x="0" y="82" font-family="Inter, Arial, sans-serif" font-weight="900" font-size="72" fill="url(#g)">
          FinalSay.ai
        </text>
      </svg>
      <nav class="nav">
        <a href="/history.html">History</a>
        <a href="/privacy.html">Privacy</a>
        <a href="/terms.html">Terms</a>
      </nav>
    </header>

    <div class="container">
      <h1>Paste a message. Pick a voice. Drop a mic.</h1>
      <div class="callout">
        <div class="icon">üí°</div>
        <div><b>Paste any message, post, or comment ‚Äî OR upload a screenshot ‚Äî to get instant, human‚Äësounding replies in any voice.</b></div>
      </div>
      <div class="hint">You‚Äôll get 3 sharp, quotable replies. Tap to copy. Your history is saved on this device.</div>

      <label for="text">Paste the message you want to reply to</label>
      <textarea id="text" placeholder="Paste the message, post, or comment here‚Ä¶ (1‚Äì3 sentences works best)"></textarea>

      <!-- OCR Uploader -->
      <div class="uploader" id="uploader">
        <div class="row">
          <!-- Choose from photo library -->
          <label for="filePhotos" class="pick">Choose from Photos</label>
          <input id="filePhotos" type="file" accept="image/*" />
          <!-- Open camera directly (supported on most mobile browsers) -->
          <label for="fileCamera" class="camera">Take a Photo</label>
          <input id="fileCamera" type="file" accept="image/*" capture="environment" />
          <span class="hint">Or drag & drop a screenshot here ‚Äî processed on your device.</span>
        </div>
        <div class="ocr-status" id="ocrStatus">No image selected.</div>
        <div class="ocr-progress"><div id="ocrFill" class="ocr-fill"></div></div>
      </div>

      <label>Choose a voice</label>
      <div class="tones" id="tones">
        <button class="tone active" data-tone="Savage">Savage üî•</button>
        <button class="tone" data-tone="Witty & Sarcastic">Witty & Sarcastic üòè</button>
        <button class="tone" data-tone="Inspirational & Profound">Inspirational & Profound üåå</button>
        <button class="tone" data-tone="Playful Roast">Playful Roast üòÇ</button>
        <button class="tone" data-tone="Petty & Precise">Petty & Precise ‚úÇÔ∏è</button>
        <button class="tone" data-tone="Diplomatic Assassin">Diplomatic Assassin üïäÔ∏è</button>
        <button class="tone" data-tone="Chaotic Genius">Chaotic Genius üåÄ</button>
      </div>

      <div class="actions">
        <button id="generate" class="btn">Generate Replies</button>
      </div>
      <div id="status" class="hint"></div>

      <div id="output"></div>

      <!-- Usage meter -->
      <div class="meter" aria-live="polite">
        <div class="bar"><div id="fill" class="fill"></div></div>
        <div id="counter" class="count">0 / 10 free today</div>
      </div>

      <!-- Example tone outputs -->
      <div class="examples" id="examples">
        <div class="hint">Example (same message, 7 voices)</div>
        <div class="exline"><span class="exlabel">Message:</span> ‚ÄúSome people just don‚Äôt get it. Simplicity is the key to genius.‚Äù</div>
        <div class="exline"><span class="exlabel">Savage:</span> Genius? You‚Äôre still trying to unlock the shopping cart at Aldi.</div>
        <div class="exline"><span class="exlabel">Witty & Sarcastic:</span> Ah yes, the eternal wisdom of fridge-magnet philosophy.</div>
        <div class="exline"><span class="exlabel">Inspirational & Profound:</span> True genius is the courage to keep the simple honest without making it small.</div>
        <div class="exline"><span class="exlabel">Playful Roast:</span> Did Confucius DM you that, or did a fortune cookie hit ‚Äúsend‚Äù again?</div>
        <div class="exline"><span class="exlabel">Petty & Precise:</span> Odd mantra for someone who filed three paragraphs to define ‚Äúsimple.‚Äù</div>
        <div class="exline"><span class="exlabel">Diplomatic Assassin:</span> I respect the premise; without context, though, simplicity often reads like neglect.</div>
        <div class="exline"><span class="exlabel">Chaotic Genius:</span> If simplicity‚Äôs the key, why did Da Vinci keep misplacing it in 7,000 doodles?</div>
      </div>
    </div>

    <footer>
      <a href="/privacy.html">Privacy Policy</a> |
      <a href="/terms.html">Terms of Use</a>
    </footer>
  </div>

<!-- Tesseract.js (client-side OCR) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<script>
  // ---- Tone pills ----
  let tone = "Savage"; // default voice on load
  document.getElementById('tones').addEventListener('click', (e)=>{
    if(!e.target.classList.contains('tone')) return;
    document.querySelectorAll('.tone').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    tone = e.target.dataset.tone;
  });

  // ---- Usage meter (local only, resets at midnight) ----
  const DAILY_LIMIT = 10; // visible only; not enforced yet
  function todayKey(){
    const d = new Date(); // local time
    return `fs_uses_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  function getCount(){ return Number(localStorage.getItem(todayKey())||0); }
  function bumpCount(){ const k=todayKey(); const v=getCount()+1; localStorage.setItem(k, String(v)); refreshMeter(); }
  function refreshMeter(){
    const used = getCount();
    const pct = Math.min(100, Math.round((used/DAILY_LIMIT)*100));
    document.getElementById('fill').style.width = pct + '%';
    document.getElementById('counter').textContent = `${used} / ${DAILY_LIMIT} free today`;
  }
  refreshMeter();

  // ---- Helpers ----
  const stripOuterQuotes = s => s.replace(/^["‚Äú‚Äù'`]+|["‚Äú‚Äù'`]+$/g,'');
  const cleanLine = s => stripOuterQuotes(s.replace(/^\s*\d+\.\s*/, '').trim());
  const saveHistory = (input, items, toneSel) => {
    const entry = { ts: Date.now(), tone: toneSel, input, items };
    const list = JSON.parse(localStorage.getItem('fs_history')||'[]');
    list.unshift(entry);
    localStorage.setItem('fs_history', JSON.stringify(list.slice(0,20)));
  };

  // ---- Generate ----
  const btn = document.getElementById('generate');
  const out = document.getElementById('output');
  const statusEl = document.getElementById('status');

  btn.addEventListener('click', async ()=>{
    const text = document.getElementById('text').value.trim();
    if(!text) return alert('Paste a message first.');

    btn.disabled = true; btn.textContent = 'Thinking‚Ä¶';
    statusEl.textContent = 'Drafting comebacks‚Ä¶';
    out.innerHTML = '';

    try {
      const res = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ text, tone })
      });
      const data = await res.json();
      if(!res.ok) throw new Error(data.error || 'Error');

      let items = Array.isArray(data.replies) ? data.replies : String(data.replies).split(/\n/);
      items = items.map(cleanLine).filter(Boolean);

      if(!items.length){
        out.innerHTML = `<div class="reply">No replies generated. Try rephrasing or a different voice.</div>`;
      } else {
        out.innerHTML = items.map(r => `<div class="reply">${r.replace(/</g,'&lt;')}</div>`).join('');
        Array.from(out.querySelectorAll('.reply')).forEach(div=>{
          div.addEventListener('click', async ()=>{
            await navigator.clipboard.writeText(div.textContent);
            div.classList.add('copied'); setTimeout(()=>div.classList.remove('copied'), 700);
          });
        });
        // Save history + increment visible meter
        saveHistory(text, items, tone);
        bumpCount();
      }
      statusEl.textContent = '';
    } catch (e) {
      out.innerHTML = `<div class="reply">Error: ${e.message}</div>`;
      statusEl.textContent = 'Try again in a moment.';
    } finally {
      btn.disabled = false; btn.textContent = 'Generate Replies';
    }
  });

  // ---- OCR (client-side, drag & drop + photo library + camera) ----
  const uploader = document.getElementById('uploader');
  const filePhotos = document.getElementById('filePhotos');   // opens photo library
  const fileCamera = document.getElementById('fileCamera');   // opens camera (mobile)
  const ocrStatus = document.getElementById('ocrStatus');
  const ocrFill = document.getElementById('ocrFill');

  filePhotos.addEventListener('change', ()=>{ if(filePhotos.files?.[0]) handleFile(filePhotos.files[0]); });
  fileCamera.addEventListener('change', ()=>{ if(fileCamera.files?.[0]) handleFile(fileCamera.files[0]); });

  ;['dragenter','dragover'].forEach(evt=>{
    uploader.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); uploader.classList.add('drag'); ocrStatus.textContent = 'Drop image to extract text‚Ä¶'; });
  });
  ;['dragleave','drop'].forEach(evt=>{
    uploader.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); uploader.classList.remove('drag'); });
  });
  uploader.addEventListener('drop', e=>{
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if(file) handleFile(file);
  });

  // Resize very large images before OCR (faster + fewer mobile memory issues)
  async function preprocessImage(file, maxW = 1800, maxH = 1800){
    const img = document.createElement('img');
    const fr = new FileReader();
    const loaded = new Promise((resolve, reject)=>{
      img.onload = ()=>resolve();
      img.onerror = reject;
    });
    const read = new Promise((resolve)=>{ fr.onload = ()=>{ img.src = fr.result; resolve(); }; fr.readAsDataURL(file); });
    await read; await loaded;

    const { width:w, height:h } = img;
    let nw = w, nh = h;
    const scale = Math.min(1, maxW/w, maxH/h);
    if (scale < 1) { nw = Math.round(w*scale); nh = Math.round(h*scale); }

    const canvas = document.createElement('canvas');
    canvas.width = nw; canvas.height = nh;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, nw, nh);

    const blob = await new Promise(resolve => canvas.toBlob(b => resolve(b), 'image/jpeg', 0.9));
    return new File([blob], file.name.replace(/\.\w+$/, '') + '.jpg', { type:'image/jpeg' });
  }

  async function handleFile(file){
    if(!file || !file.type.startsWith('image/')) return alert('Please choose an image file.');
    ocrStatus.textContent = `Reading text from ${file.name}‚Ä¶`;
    ocrFill.style.width = '0%';

    try {
      // Downscale huge images (screenshots are fine; photos can be massive)
      const prepped = (file.size > 2_000_000) ? await preprocessImage(file) : file;

      // Proper Tesseract init sequence (most compatible across mobile/desktop)
      const worker = await Tesseract.createWorker({ logger: m=>{
        if(m.status === 'recognizing text' && m.progress != null){
          ocrFill.style.width = Math.round(m.progress*100) + '%';
        }
      }});
      await worker.load();
      await worker.loadLanguage('eng');
      await worker.initialize('eng');

      const { data: { text } } = await worker.recognize(prepped);
      await worker.terminate();

      const trimmed = (text || '').replace(/\s+\n/g,'\n').trim();
      if(trimmed){
        const ta = document.getElementById('text');
        ta.value = trimmed;
        ocrStatus.textContent = 'Text extracted. You can edit it above or generate replies now.';
        ta.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        ocrStatus.textContent = 'No readable text detected. Try a clearer screenshot or a different photo.';
      }
    } catch (err) {
      console.error(err);
      ocrStatus.textContent = 'OCR failed. Please try another image.';
    }
  }
</script>
</body>
</html>
