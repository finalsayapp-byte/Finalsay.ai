<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FinalSay.ai — History</title>
<style>
  :root{--bg:#0f0f12;--panel:#17171c;--line:#2a2a36;--text:#eef;--muted:#a8a8b6;--accent:#ff5c5c;--accent2:#ff7a7a}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:1040px;margin:0 auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  .logo{display:block;width:220px;max-width:60vw}
  .nav{display:flex;gap:10px;flex-wrap:wrap}
  .nav a{background:#21212a;color:#fff;border:1px solid var(--line);padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:800}
  h1{font-size:clamp(22px,4.5vw,30px);margin:10px 0 4px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  input[type="search"],select{background:#1e1e26;color:#eef;border:1px solid var(--line);border-radius:10px;padding:10px}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border:none;padding:10px 12px;border-radius:10px;font-weight:900;cursor:pointer}
  .btn.ghost{background:#21212a;border:1px solid var(--line)}
  .list{display:flex;flex-direction:column;gap:12px;margin-top:14px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .meta{color:var(--muted);font-size:12px}
  .section{margin-top:8px}
  .label{font-size:12px;color:#aeb}
  pre{white-space:pre-wrap;margin:6px 0 0}
  .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#21212a;color:#eee;font-size:12px}
  .empty{color:#a8a8b6;margin-top:16px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <a href="/"><svg class="logo" viewBox="0 0 680 120" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#ff5c5c"/><stop offset="100%" stop-color="#ff9a7a"/></linearGradient></defs><text x="0" y="82" font-family="Inter, Arial, sans-serif" font-weight="900" font-size="72" fill="url(#g)">FinalSay.ai</text></svg></a>
    <nav class="nav">
      <a href="/">Modes</a><a href="/simple.html">Simple</a><a href="/advanced.html">Advanced</a><a href="/privacy.html">Privacy</a><a href="/terms.html">Terms</a>
    </nav>
  </header>

  <h1>History</h1>
  <div class="controls">
    <input id="q" type="search" placeholder="Search text, tone, intent…"/>
    <select id="mode">
      <option value="">All modes</option>
      <option value="simple">Simple</option>
      <option value="advanced">Advanced</option>
    </select>
    <button id="export" class="btn">Export JSON</button>
    <button id="clear" class="btn ghost">Clear All</button>
  </div>

  <div id="list" class="list"></div>
  <div id="empty" class="empty" style="display:none">No history yet.</div>
</div>

<script>
  const LS_KEY='fs_history';

  function load(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }
    catch{ return []; }
  }
  function save(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)); }

  function fmtTs(ts){
    try{
      const d=new Date(ts); return d.toLocaleString();
    }catch{ return String(ts); }
  }

  function render(){
    const listEl=document.getElementById('list');
    const empty=document.getElementById('empty');
    const q=document.getElementById('q').value.toLowerCase().trim();
    const mode=document.getElementById('mode').value;

    const items=load();
    let shown=items.filter(it=>{
      if(mode && it.mode!==mode) return false;
      if(!q) return true;
      const hay = [
        it.mode||'',
        it.tone||'',
        (it.input||''),
        ...(it.items||[]),
        it.scenario||'',
        it.intentText||'',
        ...(it.intents||[]),
        JSON.stringify(it.sliders||{})
      ].join(' ').toLowerCase();
      return hay.includes(q);
    });

    listEl.innerHTML='';
    if(!shown.length){ empty.style.display='block'; return; }
    empty.style.display='none';

    shown.forEach((it,idx)=>{
      const pills=[];
      if(it.mode) pills.push(`<span class="pill">${it.mode}</span>`);
      if(it.tone) pills.push(`<span class="pill">Tone: ${it.tone}</span>`);
      if(it.intents && it.intents.length) pills.push(...it.intents.map(v=>`<span class="pill">${v}</span>`));

      const sliders = it.sliders ? Object.entries(it.sliders).map(([k,v])=>`${k}:${v}`).join(' · ') : '';

      const body = it.mode==='simple'
        ? `<div class="section"><div class="label">Message</div><pre>${(it.input||'').replace(/</g,'&lt;')}</pre></div>
           <div class="section"><div class="label">Replies</div><pre>${(it.items||[]).join('\n\n').replace(/</g,'&lt;')}</pre></div>`
        : `<div class="section"><div class="label">Scenario</div><pre>${(it.scenario||'').replace(/</g,'&lt;')}</pre></div>
           <div class="section"><div class="label">Intent</div><pre>${(it.intentText||'').replace(/</g,'&lt;')}</pre></div>
           ${sliders?`<div class="section"><div class="label">Sliders</div><pre>${sliders}</pre></div>`:''}
           <div class="section"><div class="label">Reply</div><pre>${(it.output||'').replace(/</g,'&lt;')}</pre></div>`;

      const html = `
        <div class="card" data-idx="${idx}">
          <div class="row">
            <div class="meta">${fmtTs(it.ts)}</div>
            <div class="meta">${pills.join(' ')}</div>
          </div>
          ${body}
          <div class="actions">
            ${it.mode==='simple'
              ? '<button class="btn copy" data-type="replies">Copy Replies</button>'
              : '<button class="btn copy" data-type="reply">Copy Reply</button>'}
            <button class="btn ghost del">Delete</button>
          </div>
        </div>`;
      listEl.insertAdjacentHTML('beforeend', html);
    });

    // wire actions
    listEl.querySelectorAll('.copy').forEach(btn=>{
      btn.onclick=async()=>{
        const card=btn.closest('.card'); const idx=Number(card.dataset.idx);
        const it=shown[idx];
        const text = it.mode==='simple' ? (it.items||[]).join('\n\n') : (it.output||'');
        await navigator.clipboard.writeText(text||'');
        btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy ' + (it.mode==='simple'?'Replies':'Reply'), 800);
      };
    });
    listEl.querySelectorAll('.del').forEach(btn=>{
      btn.onclick=()=>{
        const card=btn.closest('.card'); const ts=card.querySelector('.meta').textContent;
        const all=load();
        // delete by timestamp match
        const metaTs = card.querySelector('.meta').textContent;
        const cleaned = all.filter(x => fmtTs(x.ts)!==metaTs);
        save(cleaned); render();
      };
    });
  }

  document.getElementById('q').oninput=render;
  document.getElementById('mode').onchange=render;
  document.getElementById('export').onclick=()=>{
    const data = JSON.stringify(load(), null, 2);
    const blob = new Blob([data], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='finalsay_history.json'; a.click();
    URL.revokeObjectURL(url);
  };
  document.getElementById('clear').onclick=()=>{
    if(confirm('Clear all saved history on this device?')){ localStorage.removeItem(LS_KEY); render(); }
  };

  render();
</script>
</body>
</html>
